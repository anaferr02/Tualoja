<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Publicar alojamiento - TuAloja</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Solo para las fotos (no te cambia el estilo general) */
    .preview-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .preview-item{
      border-radius: 14px;
      overflow: hidden;
      background: rgba(255,255,255,.6);
      border: 1px solid rgba(0,0,0,.08);
    }
    .preview-item img{
      width:100%;
      height:110px;
      object-fit:cover;
      display:block;
    }
    .preview-actions{
      display:flex;
      justify-content:space-between;
      gap:8px;
      padding:8px;
      font-size:12px;
      align-items:center;
    }
    .mini-btn{
      border: 0;
      cursor:pointer;
      padding:6px 8px;
      border-radius: 10px;
      background: rgba(0,0,0,.08);
    }
    .mini-badge{
      font-size:11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,.65);
      color:#fff;
    }
  </style>
</head>
<body>

  <!-- üîí Protecci√≥n: si no est√° logueada, vuelve a login -->
  <script>
    if (localStorage.getItem("tualoja_logged") !== "1") {
      localStorage.setItem("redirect_after_login", "publicar.html");
      location.href = "login.html";
    }
  </script>

  <header class="header">
    <a class="logo" href="index.html">TuAloja.com</a>
    <nav id="mainNav" class="nav">
      <a href="alojamiento.html">Registr√° tu alojamiento</a>
      <a href="ayuda.html">Ayuda</a>
      <span id="navAuth"></span>
    </nav>
    <button id="hamburgerBtn" class="hamburger" type="button">‚ò∞</button>
  </header>

  <main class="contenedor">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin: 18px 0;">
      <div>
        <h1 style="margin:0;">Publicar alojamiento</h1>
        <p class="muted" style="margin:6px 0 0;">MVP sin mapa (gratis). Luego lo sumamos.</p>
      </div>
      <button class="btn btn-outline" type="button" id="btnLogout">Cerrar sesi√≥n</button>
    </div>

    <form id="publishForm" class="card" style="padding:16px;">
      <!-- INFO B√ÅSICA -->
      <h2 style="margin-top:0;">Informaci√≥n b√°sica</h2>

      <label>Nombre del alojamiento *</label>
      <input name="titulo" required placeholder="Ej: Caba√±a en el r√≠o" />

      <label>Tipo de alojamiento *</label>
      <select name="tipo" required>
        <option value="">Eleg√≠ una opci√≥n</option>
        <option>Departamento</option>
        <option>Casa</option>
        <option>Caba√±a</option>
        <option>Habitaci√≥n</option>
        <option>Hotel</option>
        <option>Hostel</option>
        <option>Otro</option>
      </select>

      <label>Capacidad (hu√©spedes) *</label>
      <input name="capacidad" type="number" min="1" required placeholder="Ej: 4" />

      <label>Descripci√≥n *</label>
      <textarea name="descripcion" rows="4" required placeholder="Cont√° lo mejor del alojamiento..."></textarea>

      <hr style="margin: 16px 0; opacity:.3;" />

      <!-- UBICACI√ìN (sin mapa) -->
      <h2>Ubicaci√≥n</h2>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;">
        <div>
          <label>Provincia *</label>
          <input name="provincia" required placeholder="Ej: Entre R√≠os" />
        </div>
        <div>
          <label>Ciudad *</label>
          <input name="ciudad" required placeholder="Ej: Villa Elisa" />
        </div>
      </div>

      <label>Direcci√≥n aproximada (opcional)</label>
      <input name="direccion" placeholder="Ej: zona centro / cerca de..." />

      <label>C√≥digo postal (opcional)</label>
      <input name="cp" placeholder="Ej: 3265" />

      <hr style="margin: 16px 0; opacity:.3;" />

      <!-- SERVICIOS -->
      <h2>Servicios</h2>
      <div class="checks">
        <label><input type="checkbox" name="servicios" value="Wifi" /> Wifi</label>
        <label><input type="checkbox" name="servicios" value="Aire acondicionado" /> Aire acondicionado</label>
        <label><input type="checkbox" name="servicios" value="Calefacci√≥n" /> Calefacci√≥n</label>
        <label><input type="checkbox" name="servicios" value="Cocina" /> Cocina</label>
        <label><input type="checkbox" name="servicios" value="Estacionamiento" /> Estacionamiento</label>
        <label><input type="checkbox" name="servicios" value="Pileta" /> Pileta</label>
        <label><input type="checkbox" name="servicios" value="Parrilla" /> Parrilla</label>
        <label><input type="checkbox" name="servicios" value="Mascotas" /> Acepta mascotas</label>
      </div>

      <hr style="margin: 16px 0; opacity:.3;" />

      <!-- FOTOS -->
      <h2>Fotos</h2>
      <p class="muted" style="margin-top:-6px;">Pod√©s subir varias. Pod√©s borrar y elegir portada.</p>
      <input id="fotos" type="file" accept="image/*" multiple />
      <div id="preview" class="preview-grid"></div>

      <hr style="margin: 16px 0; opacity:.3;" />

      <!-- PRECIO -->
      <h2>Precio</h2>
      <label>Precio por noche (ARS) *</label>
      <input name="precio" type="number" min="0" required placeholder="Ej: 35000" />

      <label>M√°ximo de noches (opcional)</label>
      <input name="maxNoches" type="number" min="1" placeholder="Ej: 14" />

      <hr style="margin: 16px 0; opacity:.3;" />

      <!-- ANFITRI√ìN -->
      <h2>Datos del anfitri√≥n</h2>
      <label>Nombre del anfitri√≥n *</label>
      <input name="anfitrion" required placeholder="Ej: Ana Laura" />

      <label>Tel√©fono (opcional)</label>
      <input name="telefono" placeholder="Ej: +54 9 3447..." />

      <label>Email de contacto *</label>
      <input name="email" type="email" required placeholder="Ej: contacto@tualoja.com" />

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 16px;">
        <button class="btn" type="submit" id="btnPublish">Publicar</button>
        <a class="btn btn-outline" href="index.html">Cancelar</a>
      </div>

      <p class="muted" id="msg" style="margin-top:12px;"></p>
    </form>
  </main>

  <footer class="footer-ayuda">
    <p>¬© 2026 TuAloja. Todos los derechos reservados.</p>
    <div class="footer-links">
      <a href="politica-de-privacidad.html">Pol√≠tica de Privacidad</a>
      <span>|</span>
      <a href="terminos-y-condiciones.html">T√©rminos y Condiciones</a>
      <span>|</span>
      <a href="politica-de-cancelacion.html">Pol√≠tica de Cancelaciones</a>
      <span>|</span>
      <a href="politica-anti-estafas.html">Pol√≠tica Anti-Estafas</a>
    </div>
  </footer>

  <script src="script.js"></script>
  <script>
    // Logout
    document.getElementById("btnLogout").addEventListener("click", () => {
      localStorage.setItem("tualoja_logged", "0");
      localStorage.removeItem("tualoja_user");
      location.href = "index.html";
    });

    // Fotos: preview + borrar + portada
    const fotosInput = document.getElementById("fotos");
    const preview = document.getElementById("preview");

    // [{b64, isCover}]
    let fotos = [];

    fotosInput.addEventListener("change", async () => {
      const files = Array.from(fotosInput.files || []);
      if (!files.length) return;

      for (const file of files) {
        const b64 = await fileToBase64(file);
        fotos.push({ b64, isCover: fotos.length === 0 }); // primera = portada
      }

      fotosInput.value = ""; // permite volver a seleccionar las mismas
      renderFotos();
    });

    function renderFotos() {
      preview.innerHTML = "";
      fotos.forEach((ph, idx) => {
        const item = document.createElement("div");
        item.className = "preview-item";

        const img = document.createElement("img");
        img.src = ph.b64;

        const actions = document.createElement("div");
        actions.className = "preview-actions";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.gap = "8px";
        left.style.alignItems = "center";

        const btnCover = document.createElement("button");
        btnCover.type = "button";
        btnCover.className = "mini-btn";
        btnCover.textContent = "Portada";
        btnCover.addEventListener("click", () => {
          fotos = fotos.map((x, i) => ({ ...x, isCover: i === idx }));
          renderFotos();
        });

        const btnDel = document.createElement("button");
        btnDel.type = "button";
        btnDel.className = "mini-btn";
        btnDel.textContent = "Borrar";
        btnDel.addEventListener("click", () => {
          const wasCover = fotos[idx]?.isCover;
          fotos.splice(idx, 1);
          if (wasCover && fotos.length) fotos[0].isCover = true;
          renderFotos();
        });

        left.appendChild(btnCover);
        left.appendChild(btnDel);

        const right = document.createElement("span");
        right.className = "mini-badge";
        right.textContent = ph.isCover ? "Portada" : `${idx + 1}/${fotos.length}`;

        actions.appendChild(left);
        actions.appendChild(right);

        item.appendChild(img);
        item.appendChild(actions);
        preview.appendChild(item);
      });
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    // Publicar: guarda en localStorage
    document.getElementById("publishForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const f = e.currentTarget;

      const servicios = Array.from(f.querySelectorAll('input[name="servicios"]:checked'))
        .map(i => i.value);

      // portada primero
      const fotosOrdenadas = [...fotos].sort((a,b) => (b.isCover ? 1 : 0) - (a.isCover ? 1 : 0));
      const fotosBase64 = fotosOrdenadas.map(x => x.b64);

      const data = {
        id: "alo_" + Date.now(),
        titulo: f.titulo.value.trim(),
        tipo: f.tipo.value,
        capacidad: Number(f.capacidad.value),
        descripcion: f.descripcion.value.trim(),
        direccion: f.direccion.value.trim(),
        ciudad: f.ciudad.value.trim(),
        provincia: f.provincia.value.trim(),
        cp: f.cp.value.trim(),
        servicios,
        fotos: fotosBase64,
        precio: Number(f.precio.value),
        maxNoches: f.maxNoches.value ? Number(f.maxNoches.value) : null,
        anfitrion: f.anfitrion.value.trim(),
        telefono: f.telefono.value.trim(),
        email: f.email.value.trim()
      };

      const arr = JSON.parse(localStorage.getItem("tualoja_listings") || "[]");
      arr.unshift(data);
      localStorage.setItem("tualoja_listings", JSON.stringify(arr));

      document.getElementById("msg").textContent = "‚úÖ Publicado (guardado en tu navegador).";
      f.reset();
      preview.innerHTML = "";
      fotos = [];
    });
  </script>
</body>
</html>
