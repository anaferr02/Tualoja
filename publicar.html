<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Publicar alojamiento - TuAloja</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ‚úÖ Estilo local SOLO para esta p√°gina (no rompe el resto) */
    .publish-wrap{ max-width: 980px; margin: 24px auto 40px; padding: 0 16px; }
    .publish-card{
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 22px;
      box-shadow: 0 18px 40px rgba(0,0,0,.12);
      padding: 18px;
    }
    .publish-top{
      display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .publish-top h1{ margin:0; }
    .muted{ opacity: .85; }

    .publish-section{
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 18px;
      padding: 14px;
      margin-top: 12px;
    }
    .publish-section h3{ margin: 0 0 10px; }

    .grid-2{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
    @media (max-width: 720px){ .grid-2{ grid-template-columns: 1fr; } }

    /* inputs */
    .publish-card label{ display:block; font-weight: 600; margin-top: 10px; }
    .publish-card input, .publish-card select, .publish-card textarea{
      width:100%; box-sizing:border-box;
      margin-top: 6px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.12);
      background: #fff;
      outline: none;
    }
    .publish-card textarea{ resize: vertical; }

    .checks{
      display:flex; flex-wrap:wrap; gap:10px;
    }
    .checks label{
      margin:0; font-weight: 500;
      display:inline-flex; gap:8px; align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.05);
      border: 1px solid rgba(0,0,0,.06);
    }

    /* Fotos */
    .preview-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .preview-item{
      border-radius: 16px;
      overflow: hidden;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(0,0,0,.08);
    }
    .preview-item img{
      width:100%; height:120px; object-fit:cover; display:block;
    }
    .preview-actions{
      display:flex; justify-content:space-between; align-items:center;
      gap:8px; padding: 8px 10px; font-size: 12px;
    }
    .mini-btn{
      border:0; cursor:pointer;
      padding: 7px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,.08);
    }
    .mini-badge{
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.65);
      color:#fff;
      white-space:nowrap;
    }

    .publish-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
    .btn{ cursor:pointer; }
  </style>
</head>

<body>
  <!-- üîí Protecci√≥n: solo logueado -->
  <script>
    if (localStorage.getItem("tualoja_logged") !== "1") {
      localStorage.setItem("redirect_after_login", "publicar.html");
      location.href = "login.html";
    }
  </script>

  <!-- üîÅ Importante: dej√° tu header real (igual que index.html) -->
  <header class="header">
    <a class="logo" href="index.html">TuAloja.com</a>
    <nav id="mainNav" class="nav">
      <a href="alojamiento.html">Registr√° tu alojamiento</a>
      <a href="ayuda.html">Ayuda</a>
      <span id="navAuth"></span>
    </nav>
    <button id="hamburgerBtn" class="hamburger" type="button">‚ò∞</button>
  </header>

  <main class="publish-wrap">
    <div class="publish-card">
      <div class="publish-top">
        <div>
          <h1>Publicar alojamiento</h1>
          <p class="muted" style="margin:6px 0 0;">
            Sub√≠ fotos, complet√° datos y public√°. (MVP: se guarda en tu navegador)
          </p>
        </div>
        <button class="btn btn-outline" type="button" id="btnLogout">Cerrar sesi√≥n</button>
      </div>

      <form id="publishForm">
        <!-- INFO B√ÅSICA -->
        <section class="publish-section">
          <h3>Informaci√≥n b√°sica</h3>

          <label>Nombre del alojamiento *</label>
          <input name="titulo" required placeholder="Ej: Caba√±a en el r√≠o" />

          <div class="grid-2">
            <div>
              <label>Tipo de alojamiento *</label>
              <select name="tipo" required>
                <option value="">Eleg√≠ una opci√≥n</option>
                <option>Departamento</option>
                <option>Casa</option>
                <option>Caba√±a</option>
                <option>Habitaci√≥n</option>
                <option>Hotel</option>
                <option>Hostel</option>
                <option>Otro</option>
              </select>
            </div>
            <div>
              <label>Capacidad (hu√©spedes) *</label>
              <input name="capacidad" type="number" min="1" required placeholder="Ej: 4" />
            </div>
          </div>

          <label>Descripci√≥n *</label>
          <textarea name="descripcion" rows="4" required placeholder="Cont√° lo mejor del alojamiento..."></textarea>
        </section>

        <!-- UBICACI√ìN (sin Maps) -->
        <section class="publish-section">
          <h3>Ubicaci√≥n</h3>

          <div class="grid-2">
            <div>
              <label>Provincia *</label>
              <input name="provincia" required placeholder="Ej: Entre R√≠os" />
            </div>
            <div>
              <label>Ciudad *</label>
              <input name="ciudad" required placeholder="Ej: Villa Elisa" />
            </div>
          </div>

          <label>Direcci√≥n aproximada (opcional)</label>
          <input name="direccion" placeholder="Ej: a 3 cuadras de la plaza..." />

          <label>C√≥digo postal (opcional)</label>
          <input name="cp" placeholder="Ej: 3265" />
        </section>

        <!-- SERVICIOS -->
        <section class="publish-section">
          <h3>Servicios</h3>
          <div class="checks">
            <label><input type="checkbox" name="servicios" value="Wifi" /> Wifi</label>
            <label><input type="checkbox" name="servicios" value="Aire acondicionado" /> Aire acondicionado</label>
            <label><input type="checkbox" name="servicios" value="Calefacci√≥n" /> Calefacci√≥n</label>
            <label><input type="checkbox" name="servicios" value="Cocina" /> Cocina</label>
            <label><input type="checkbox" name="servicios" value="Estacionamiento" /> Estacionamiento</label>
            <label><input type="checkbox" name="servicios" value="Pileta" /> Pileta</label>
            <label><input type="checkbox" name="servicios" value="Parrilla" /> Parrilla</label>
            <label><input type="checkbox" name="servicios" value="Mascotas" /> Mascotas</label>
          </div>
        </section>

        <!-- FOTOS -->
        <section class="publish-section">
          <h3>Fotos</h3>
          <p class="muted" style="margin-top:-6px;">
            Sub√≠ varias. Pod√©s <strong>borrar</strong> y elegir <strong>portada</strong>.
          </p>

          <input id="fotos" type="file" accept="image/*" multiple />
          <div id="preview" class="preview-grid"></div>
        </section>

        <!-- PRECIO -->
        <section class="publish-section">
          <h3>Precio</h3>

          <div class="grid-2">
            <div>
              <label>Precio por noche (ARS) *</label>
              <input name="precio" type="number" min="0" required placeholder="Ej: 35000" />
            </div>
            <div>
              <label>M√°ximo de noches (opcional)</label>
              <input name="maxNoches" type="number" min="1" placeholder="Ej: 14" />
            </div>
          </div>
        </section>

        <!-- ANFITRI√ìN -->
        <section class="publish-section">
          <h3>Datos del anfitri√≥n</h3>

          <div class="grid-2">
            <div>
              <label>Nombre del anfitri√≥n *</label>
              <input name="anfitrion" required placeholder="Ej: Ana Laura" />
            </div>
            <div>
              <label>Tel√©fono (opcional)</label>
              <input name="telefono" placeholder="Ej: +54 9 3447..." />
            </div>
          </div>

          <label>Email de contacto *</label>
          <input name="email" type="email" required placeholder="Ej: contacto@tualoja.com" />
        </section>

        <div class="publish-actions">
          <button class="btn" type="submit">Publicar</button>
          <a class="btn btn-outline" href="index.html">Volver a inicio</a>
        </div>

        <p class="muted" id="msg" style="margin-top:12px;"></p>
      </form>
    </div>
  </main>

  <footer class="footer-ayuda">
    <p>¬© 2026 TuAloja. Todos los derechos reservados.</p>
    <div class="footer-links">
      <a href="politica-de-privacidad.html">Pol√≠tica de Privacidad</a>
      <span>|</span>
      <a href="terminos-y-condiciones.html">T√©rminos y Condiciones</a>
      <span>|</span>
      <a href="politica-de-cancelacion.html">Pol√≠tica de Cancelaciones</a>
      <span>|</span>
      <a href="politica-anti-estafas.html">Pol√≠tica Anti-Estafas</a>
    </div>
  </footer>

  <script src="script.js"></script>
  <script>
    // Logout
    document.getElementById("btnLogout").addEventListener("click", () => {
      localStorage.setItem("tualoja_logged", "0");
      localStorage.removeItem("tualoja_user");
      location.href = "index.html";
    });

    // Fotos: preview + borrar + portada
    const fotosInput = document.getElementById("fotos");
    const preview = document.getElementById("preview");
    let fotos = []; // [{b64,isCover}]

    fotosInput.addEventListener("change", async () => {
      const files = Array.from(fotosInput.files || []);
      if (!files.length) return;

      for (const file of files) {
        const b64 = await fileToBase64(file);
        fotos.push({ b64, isCover: fotos.length === 0 });
      }

      fotosInput.value = "";
      renderFotos();
    });

    function renderFotos() {
      preview.innerHTML = "";
      fotos.forEach((ph, idx) => {
        const item = document.createElement("div");
        item.className = "preview-item";

        const img = document.createElement("img");
        img.src = ph.b64;

        const actions = document.createElement("div");
        actions.className = "preview-actions";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.gap = "8px";

        const btnCover = document.createElement("button");
        btnCover.type = "button";
        btnCover.className = "mini-btn";
        btnCover.textContent = "Portada";
        btnCover.onclick = () => {
          fotos = fotos.map((x, i) => ({ ...x, isCover: i === idx }));
          renderFotos();
        };

        const btnDel = document.createElement("button");
        btnDel.type = "button";
        btnDel.className = "mini-btn";
        btnDel.textContent = "Borrar";
        btnDel.onclick = () => {
          const wasCover = fotos[idx]?.isCover;
          fotos.splice(idx, 1);
          if (wasCover && fotos.length) fotos[0].isCover = true;
          renderFotos();
        };

        left.appendChild(btnCover);
        left.appendChild(btnDel);

        const badge = document.createElement("span");
        badge.className = "mini-badge";
        badge.textContent = ph.isCover ? "Portada" : `${idx + 1}/${fotos.length}`;

        actions.appendChild(left);
        actions.appendChild(badge);

        item.appendChild(img);
        item.appendChild(actions);
        preview.appendChild(item);
      });
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    // Publicar (localStorage) + ir a gracias.html + enviar aviso (FormSubmit opcional)
    document.getElementById("publishForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const f = e.currentTarget;

      const servicios = Array.from(f.querySelectorAll('input[name="servicios"]:checked')).map(i => i.value);

      // portada primero
      const fotosOrdenadas = [...fotos].sort((a,b) => (b.isCover ? 1 : 0) - (a.isCover ? 1 : 0));
      const fotosBase64 = fotosOrdenadas.map(x => x.b64);

      const data = {
        id: "alo_" + Date.now(),
        titulo: f.titulo.value.trim(),
        tipo: f.tipo.value,
        capacidad: Number(f.capacidad.value),
        descripcion: f.descripcion.value.trim(),
        direccion: f.direccion.value.trim(),
        ciudad: f.ciudad.value.trim(),
        provincia: f.provincia.value.trim(),
        cp: f.cp.value.trim(),
        servicios,
        fotos: fotosBase64,
        precio: Number(f.precio.value),
        maxNoches: f.maxNoches.value ? Number(f.maxNoches.value) : null,
        anfitrion: f.anfitrion.value.trim(),
        telefono: f.telefono.value.trim(),
        email: f.email.value.trim()
      };

      const arr = JSON.parse(localStorage.getItem("tualoja_listings") || "[]");
      arr.unshift(data);
      localStorage.setItem("tualoja_listings", JSON.stringify(arr));

      // ‚úÖ Mensaje inmediato
      document.getElementById("msg").textContent = "‚úÖ Publicado. Redirigiendo‚Ä¶";

      // ‚úÖ Env√≠o de email (FRONTEND) usando FormSubmit
      // Nota: FormSubmit env√≠a a tu casilla (alojamientos@tualoja.com) pero el "from" real depende del proveedor.
      // Primero ten√©s que activar FormSubmit 1 vez: mandar un form manual desde el sitio.
      try {
        const fd = new FormData();
        fd.append("Asunto", "Nueva publicaci√≥n en TuAloja");
        fd.append("T√≠tulo", data.titulo);
        fd.append("Ciudad", data.ciudad);
        fd.append("Provincia", data.provincia);
        fd.append("Precio", String(data.precio));
        fd.append("Email anfitri√≥n", data.email);
        fd.append("Tel√©fono", data.telefono);
        fd.append("_subject", "TuAloja - Nueva publicaci√≥n");
        fd.append("_template", "table");

        // ‚ö†Ô∏è Cambi√° el mail por tu casilla real
        await fetch("https://formsubmit.co/alojamientos@tualoja.com", {
          method: "POST",
          body: fd
        });
      } catch {
        // si falla, igual seguimos
      }

      // ‚úÖ Redirigir a gracias
      setTimeout(() => {
        location.href = "gracias.html";
      }, 600);
    });
  </script>
</body>
</html>
