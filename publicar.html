<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Publicar alojamiento - TuAloja</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    /* Estilos solo para el wizard (no pisa tu web) */
    .wizard-wrap{ padding:40px 0; }
    .wizard-card{
      background:#fff;
      border-radius:18px;
      padding:26px;
      box-shadow:0 10px 30px rgba(0,0,0,.12);
      max-width:900px;
      margin:auto;
    }
    .wizard-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .wizard-top h1{
      margin:0;
      color:#1b167f;
      font-size:30px;
    }
    .wizard-top p{ margin:6px 0 0; color:#444; }
    .logout{
      border:none;
      background: rgba(27,22,127,.08);
      color:#1b167f;
      font-weight:800;
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
    }

    .progress{
      width:100%;
      height:10px;
      background: rgba(27,22,127,.10);
      border-radius:999px;
      overflow:hidden;
      margin:10px 0 18px;
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(135deg, #1b167f, #3a2fcf);
      border-radius:999px;
      transition: width .25s ease;
    }

    .steps{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:18px;
      font-size:13px;
      color:#555;
    }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      background:#f3f4ff;
      border:1px solid rgba(27,22,127,.12);
    }
    .chip.active{
      background: rgba(27,22,127,.10);
      color:#1b167f;
      font-weight:800;
    }

    .step{ display:none; }
    .step.active{ display:block; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width:700px){
      .grid{ grid-template-columns:1fr; }
    }

    label{ display:block; font-size:14px; margin:10px 0 6px; color:#222; }
    input, select, textarea{
      width:100%;
      padding:12px 14px;
      border:1px solid #d6d6d6;
      border-radius:12px;
      outline:none;
      font-size:14px;
      box-sizing:border-box;
    }
    textarea{ min-height:90px; resize:vertical; }

    .full{ grid-column:1 / -1; }

    .actions{
      display:flex;
      gap:12px;
      justify-content:space-between;
      align-items:center;
      margin-top:18px;
      flex-wrap:wrap;
    }
    .btn-sec{
      border:none;
      background: rgba(0,0,0,.06);
      padding:12px 16px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
    }
    .btn-next{
      border:none;
      border-radius:999px;
      padding:12px 18px;
      cursor:pointer;
      font-weight:800;
      background: linear-gradient(135deg, #1b167f, #3a2fcf);
      color:#fff;
      box-shadow: 0 12px 30px rgba(27,22,127,0.20);
    }

    .note{
      margin-top:10px;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 12px 14px;
      border-radius: 12px;
      font-size: 13px;
    }

    .checks{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    @media (max-width:700px){
      .checks{ grid-template-columns:1fr; }
    }
    .check{
      display:flex;
      gap:10px;
      align-items:flex-start;
      background:#fafafa;
      border:1px solid #eee;
      padding:10px 12px;
      border-radius:12px;
    }
    .check input{ width:auto; margin-top:3px; }

    .photos{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .ph{
      width:120px;
      height:90px;
      border-radius:12px;
      border:1px solid #e6e6e6;
      background:#f6f6f6;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      color:#666;
    }
    .ph img{ width:100%; height:100%; object-fit:cover; }

    .summary{
      background:#fafafa;
      border:1px solid #eee;
      border-radius:14px;
      padding:14px;
      margin-top:10px;
      line-height:1.6;
      font-size:14px;
    }

    .error{
      margin-top:10px;
      color:#b00020;
      font-weight:700;
      font-size:13px;
      display:none;
    }
  </style>
</head>

<body>
  <script>
    // Protecci√≥n: si no est√° logueado, vuelve a login
    if (localStorage.getItem("tualoja_logged") !== "1") {
      window.location.href = "login.html";
    }
  </script>

  <section class="seccion seccion-transparente wizard-wrap">
    <div class="contenedor">
      <div class="wizard-card">

        <div class="wizard-top">
          <div>
            <h1>Publicar alojamiento</h1>
            <p>Complet√° los pasos. Guardamos todo autom√°ticamente.</p>
          </div>
          <button class="logout" id="btnLogout" type="button">Cerrar sesi√≥n</button>
        </div>

        <div class="progress"><div id="bar"></div></div>

        <div class="steps" id="chips">
          <span class="chip">1 B√°sico</span>
          <span class="chip">2 Ubicaci√≥n</span>
          <span class="chip">3 Servicios</span>
          <span class="chip">4 Fotos</span>
          <span class="chip">5 Precio</span>
          <span class="chip">6 Confirmar</span>
        </div>

        <div class="note">
          üõ°Ô∏è Seguridad: revisamos manualmente cada publicaci√≥n para evitar estafas y anuncios falsos.
        </div>

        <div id="err" class="error">Complet√° los campos requeridos para continuar.</div>

        <!-- FORM FINAL (se env√≠a en el paso 6) -->
        <form id="pubForm" action="https://formsubmit.co/alojamientos@tualoja.com" method="POST">
          <input type="hidden" name="_subject" value="Nuevo alojamiento - TuAloja">
          <input type="hidden" name="_template" value="table">

          <!-- Autorespuesta al anfitri√≥n (al email que se cargue en name="email") -->
          <input type="hidden" name="_autoresponse" value="¬°Gracias! Recibimos tu alojamiento en TuAloja ‚úÖ

Tu publicaci√≥n pas√≥ a revisi√≥n para evitar estafas y anuncios falsos.
Si falta alg√∫n dato, te contactamos por este mail.

‚Äî Equipo TuAloja">

          <input type="hidden" name="_next" value="https://tualoja.com/gracias.html">

          <!-- Hidden para mandar fotos como texto (nombres) -->
          <input type="hidden" name="fotos_info" id="fotos_info" value="">

          <!-- Paso 1 -->
          <div class="step active" data-step="1">
            <h2 style="margin:14px 0 6px; color:#1b167f;">Informaci√≥n b√°sica</h2>
            <div class="grid">
              <div class="full">
                <label>Nombre del alojamiento *</label>
                <input name="nombre_alojamiento" id="nombre_alojamiento" required placeholder="Ej: Caba√±a Las Palmas" />
              </div>

              <div>
                <label>Tipo de alojamiento *</label>
                <select name="tipo" id="tipo" required>
                  <option value="">Elegir</option>
                  <option>Casa</option>
                  <option>Departamento</option>
                  <option>Caba√±a</option>
                  <option>Habitaci√≥n</option>
                </select>
              </div>

              <div>
                <label>Capacidad (personas) *</label>
                <input type="number" min="1" name="capacidad" id="capacidad" required placeholder="Ej: 4" />
              </div>

              <div class="full">
                <label>Descripci√≥n *</label>
                <textarea name="descripcion" id="descripcion" required placeholder="Cont√° qu√© ofrece tu alojamiento..."></textarea>
              </div>
            </div>
          </div>

          <!-- Paso 2 -->
          <div class="step" data-step="2">
            <h2 style="margin:14px 0 6px; color:#1b167f;">Ubicaci√≥n</h2>
            <div class="grid">
              <div>
                <label>Provincia *</label>
                <input name="provincia" id="provincia" required placeholder="Ej: Entre R√≠os" />
              </div>
              <div>
                <label>Ciudad *</label>
                <input name="ciudad" id="ciudad" required placeholder="Ej: San Salvador" />
              </div>

              <div class="full">
                <label>Direcci√≥n aproximada (opcional)</label>
                <input name="direccion" id="direccion" placeholder="Ej: Zona centro / barrio..." />
              </div>
            </div>
            <div class="note" style="margin-top:12px;">
              M√°s adelante agregamos el mapa. Por ahora con ciudad y zona alcanza.
            </div>
          </div>

          <!-- Paso 3 -->
          <div class="step" data-step="3">
            <h2 style="margin:14px 0 6px; color:#1b167f;">Servicios y normas</h2>

            <label>Servicios (marc√° lo que tenga)</label>
            <div class="checks">
              <label class="check"><input type="checkbox" name="servicios" value="WiFi"> WiFi</label>
              <label class="check"><input type="checkbox" name="servicios" value="Aire acondicionado"> Aire acondicionado</label>
              <label class="check"><input type="checkbox" name="servicios" value="Cochera"> Cochera</label>
              <label class="check"><input type="checkbox" name="servicios" value="Piscina"> Piscina</label>
              <label class="check"><input type="checkbox" name="servicios" value="Parrilla"> Parrilla</label>
              <label class="check"><input type="checkbox" name="servicios" value="Se aceptan mascotas"> Se aceptan mascotas</label>
            </div>

            <label style="margin-top:14px;">Normas de la casa (opcional)</label>
            <textarea name="normas" id="normas" placeholder="Ej: No fiestas, no fumar adentro, horario de silencio..."></textarea>
          </div>

          <!-- Paso 4 -->
          <div class="step" data-step="4">
            <h2 style="margin:14px 0 6px; color:#1b167f;">Fotos</h2>
            <p style="margin:0; color:#444;">Sum√° fotos claras: aumentan mucho las reservas.</p>

            <label style="margin-top:12px;">Subir fotos (al menos 3) *</label>
            <input type="file" id="fotos" accept="image/*" multiple />
            <p id="fotosStatus" style="margin:10px 0 0; color:#444; font-weight:700;">
            Todav√≠a no cargaste fotos.
              </p>

            <div class="photos" id="photosPreview">
              <div class="ph">Vista previa</div>
            </div>

            <div class="note" style="margin-top:12px;">
              Por ahora las fotos se usan para vista previa. Despu√©s, cuando tengas backend, las subimos de verdad.
            </div>
          </div>

          <!-- Paso 5 -->
          <div class="step" data-step="5">
            <h2 style="margin:14px 0 6px; color:#1b167f;">Precio y disponibilidad</h2>
            <div class="grid">
              <div>
                <label>Precio por noche (ARS) *</label>
                <input type="number" min="0" name="precio_por_noche" id="precio" required placeholder="Ej: 45000" />
              </div>
              <div>
                <label>M√≠nimo de noches *</label>
                <input type="number" min="1" name="min_noches" id="min_noches" required placeholder="Ej: 2" />
              </div>

              <div class="full">
                <label>Check-in / Check-out (opcional)</label>
                <input name="horarios" id="horarios" placeholder="Ej: Check-in 14:00 / Check-out 10:00" />
              </div>
            </div>
          </div>

          <!-- Paso 6 -->
          <div class="step" data-step="6">
            <h2 style="margin:14px 0 6px; color:#1b167f;">Confirmar y enviar</h2>

            <div class="grid">
              <div>
                <label>Nombre del anfitri√≥n *</label>
                <input name="anfitrion_nombre" id="anfitrion_nombre" required placeholder="Ej: Ana" />
              </div>
              <div>
                <label>WhatsApp (opcional)</label>
                <input name="anfitrion_whatsapp" id="anfitrion_whatsapp" placeholder="Ej: 3447..." />
              </div>
              <div class="full">
                <label>Email del anfitri√≥n *</label>
                <input type="email" name="email" id="anfitrion_email" required>
              </div>
            </div>

            <div class="summary" id="summary"></div>

            <div class="note" style="margin-top:12px;">
              Al enviar, tu alojamiento pasa a revisi√≥n. Te contactamos por mail si falta algo.
            </div>

            <button id="btnEnviar" class="btn-next" type="submit" style="margin-top:14px;">
              Enviar alojamiento
            </button>

            <p id="enviandoMsg" style="display:none; margin-top:10px; color:#444; font-weight:700;">
              Enviando‚Ä¶ por favor no cierres esta ventana.
            </p>
          </div>

          <!-- Botones navegaci√≥n -->
          <div class="actions">
            <button type="button" class="btn-sec" id="prev">Atr√°s</button>
            <button type="button" class="btn-next" id="next">Continuar</button>
          </div>
        </form>

      </div>
    </div>
  </section>

  <script>
  window.addEventListener("DOMContentLoaded", () => {

    // Logout
    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
      btnLogout.addEventListener("click", () => {
        localStorage.removeItem("tualoja_logged");
        localStorage.removeItem("tualoja_user");
        window.location.href = "index.html";
      });
    }

    const steps = Array.from(document.querySelectorAll(".step"));
    const chips = Array.from(document.querySelectorAll("#chips .chip"));
    const bar = document.getElementById("bar");
    const err = document.getElementById("err");

    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    const pubForm = document.getElementById("pubForm");
    const summaryEl = document.getElementById("summary");

    // Elementos fotos
    const fotosInput = document.getElementById("fotos");
    const photosPreview = document.getElementById("photosPreview");
    const fotosInfoHidden = document.getElementById("fotos_info");
    const fotosStatus = document.getElementById("fotosStatus"); // si existe

    // Guardas de seguridad: si algo esencial falta, no rompemos todo
    if (!pubForm || !prevBtn || !nextBtn || !bar || !err || steps.length === 0) {
      console.error("Faltan elementos del wizard (IDs/clases). Revisar #pubForm, #prev, #next, .step, #bar, #err");
      return;
    }

    let current = 1;
    const saveKey = "tualoja_publicacion_draft";

    function saveDraft() {
      const data = {};
      const fd = new FormData(pubForm);

      data.servicios = fd.getAll("servicios");
      fd.forEach((v, k) => {
        if (k === "servicios") return;
        data[k] = v;
      });

      // guardamos nombres de fotos (texto)
      data.fotos_info = (fotosInfoHidden?.value || "");
      localStorage.setItem(saveKey, JSON.stringify(data));
    }

    function loadDraft() {
      const raw = localStorage.getItem(saveKey);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);

        for (const [k, v] of Object.entries(data)) {
          if (k === "servicios") continue;
          const el = pubForm.querySelector(`[name="${k}"]`);
          if (el) el.value = v;
        }

        if (Array.isArray(data.servicios)) {
          pubForm.querySelectorAll(`input[name="servicios"]`).forEach(c => {
            c.checked = data.servicios.includes(c.value);
          });
        }

        if (fotosInfoHidden && data.fotos_info) {
          fotosInfoHidden.value = data.fotos_info;
        }
      } catch {}
    }

    function setStep(n) {
      current = n;
      steps.forEach(s => s.classList.toggle("active", Number(s.dataset.step) === current));
      chips.forEach((c, i) => c.classList.toggle("active", i === current - 1));

      const pct = ((current - 1) / (steps.length - 1)) * 100;
      bar.style.width = pct + "%";

      prevBtn.style.visibility = current === 1 ? "hidden" : "visible";
      nextBtn.style.display = current === 6 ? "none" : "inline-flex";
      err.style.display = "none";

      if (current === 6) renderSummary();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function validateStep(n) {
      const must = {
        1: ["nombre_alojamiento", "tipo", "capacidad", "descripcion"],
        2: ["provincia", "ciudad"],
        3: [],
        5: ["precio_por_noche", "min_noches"],
        6: ["anfitrion_nombre", "email"] // whatsapp opcional
      };

      // ‚úÖ Paso 4: validamos archivo real
      if (n === 4) {
        return !!(fotosInput && fotosInput.files && fotosInput.files.length > 0);
      }

      const fields = must[n] || [];
      for (const name of fields) {
        const el = pubForm.querySelector(`[name="${name}"]`) || document.getElementById(name);
        if (!el) continue;
        const val = (el.value || "").trim();
        if (!val) return false;
      }
      return true;
    }

    function renderSummary() {
      if (!summaryEl) return;

      const get = (id) => (document.getElementById(id)?.value || "").trim();
      const servicios = Array.from(pubForm.querySelectorAll('input[name="servicios"]:checked')).map(x => x.value);
      const fotosInfo = (fotosInfoHidden?.value || "");

      summaryEl.innerHTML = `
        <b>Resumen</b><br>
        <b>Alojamiento:</b> ${get("nombre_alojamiento")} (${get("tipo")}) ‚Äî ${get("capacidad")} personas<br>
        <b>Ubicaci√≥n:</b> ${get("ciudad")}, ${get("provincia")} ${get("direccion") ? "‚Äî " + get("direccion") : ""}<br>
        <b>Servicios:</b> ${servicios.length ? servicios.join(", ") : "No especificados"}<br>
        <b>Precio:</b> ARS ${get("precio")} ‚Äî <b>M√≠nimo:</b> ${get("min_noches")} noches<br>
        <b>Fotos:</b> ${fotosInfo || "Sin fotos"}<br>
      `;
    }

    prevBtn.addEventListener("click", () => {
      saveDraft();
      setStep(Math.max(1, current - 1));
    });

    nextBtn.addEventListener("click", () => {
      saveDraft();
      if (!validateStep(current)) {
        err.style.display = "block";
        return;
      }
      setStep(Math.min(6, current + 1));
    });

    pubForm.addEventListener("input", () => saveDraft());

    // ‚úÖ Fotos: preview + status (si existen elementos)
    if (fotosInput && photosPreview && fotosInfoHidden) {
      fotosInput.addEventListener("change", () => {
        const files = Array.from(fotosInput.files || []);
        photosPreview.innerHTML = "";

        if (!files.length) {
          photosPreview.innerHTML = `<div class="ph">Vista previa</div>`;
          fotosInfoHidden.value = "";
          if (fotosStatus) fotosStatus.textContent = "Todav√≠a no cargaste fotos.";
          saveDraft();
          return;
        }

        fotosInfoHidden.value = files.map(f => f.name).join(", ");
        if (fotosStatus) {
          fotosStatus.textContent = `‚úÖ ${files.length} foto${files.length > 1 ? "s" : ""} cargada${files.length > 1 ? "s" : ""}.`;
        }

        files.slice(0, 6).forEach(file => {
          const div = document.createElement("div");
          div.className = "ph";
          const img = document.createElement("img");
          div.appendChild(img);
          photosPreview.appendChild(div);

          const reader = new FileReader();
          reader.onload = (e) => img.src = e.target.result;
          reader.readAsDataURL(file);
        });

        err.style.display = "none";
        saveDraft();
      });
    }

    // ‚úÖ Env√≠o: evitar doble env√≠o + feedback
    pubForm.addEventListener("submit", (e) => {
      if (pubForm.dataset.sending === "1") {
        e.preventDefault();
        return;
      }

      for (let i = 1; i <= 6; i++) {
        if (!validateStep(i)) {
          e.preventDefault();
          err.style.display = "block";
          setStep(i);
          return;
        }
      }

      pubForm.dataset.sending = "1";

      const btnEnviar = document.getElementById("btnEnviar");
      const enviandoMsg = document.getElementById("enviandoMsg");
      if (btnEnviar) {
        btnEnviar.disabled = true;
        btnEnviar.style.opacity = "0.7";
        btnEnviar.style.cursor = "not-allowed";
        btnEnviar.textContent = "Enviando‚Ä¶";
      }
      if (enviandoMsg) enviandoMsg.style.display = "block";

      saveDraft();
      localStorage.removeItem(saveKey);
    });

    loadDraft();
    setStep(1);
  });
</script>
</body>
</html>
