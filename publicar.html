<script>
  window.addEventListener("DOMContentLoaded", () => {

    // Logout
    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
      btnLogout.addEventListener("click", () => {
        localStorage.removeItem("tualoja_logged");
        localStorage.removeItem("tualoja_user");
        window.location.href = "index.html";
      });
    }

    const steps = Array.from(document.querySelectorAll(".step"));
    const chips = Array.from(document.querySelectorAll("#chips .chip"));
    const bar = document.getElementById("bar");
    const err = document.getElementById("err");

    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    const pubForm = document.getElementById("pubForm");
    const summaryEl = document.getElementById("summary");

    // Elementos fotos
    const fotosInput = document.getElementById("fotos");
    const photosPreview = document.getElementById("photosPreview");
    const fotosInfoHidden = document.getElementById("fotos_info");
    const fotosStatus = document.getElementById("fotosStatus");

    // ✅ PASO 2: persistencia inteligente (si ya subió fotos una vez)
    let fotosConfirmadas = false;

    // Guardas de seguridad
    if (!pubForm || !prevBtn || !nextBtn || !bar || !err || steps.length === 0) {
      console.error("Faltan elementos del wizard (IDs/clases). Revisar #pubForm, #prev, #next, .step, #bar, #err");
      return;
    }

    let current = 1;
    const saveKey = "tualoja_publicacion_draft";

    function saveDraft() {
      const data = {};
      const fd = new FormData(pubForm);

      data.servicios = fd.getAll("servicios");
      fd.forEach((v, k) => {
        if (k === "servicios") return;
        data[k] = v;
      });

      // guardamos nombres de fotos (texto)
      data.fotos_info = (fotosInfoHidden?.value || "");
      // ✅ guardamos también si ya fueron confirmadas
      data.fotos_confirmadas = fotosConfirmadas ? "1" : "0";

      localStorage.setItem(saveKey, JSON.stringify(data));
    }

    function loadDraft() {
      const raw = localStorage.getItem(saveKey);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);

        for (const [k, v] of Object.entries(data)) {
          if (k === "servicios" || k === "fotos_confirmadas") continue;
          const el = pubForm.querySelector(`[name="${k}"]`);
          if (el) el.value = v;
        }

        if
